import pandas as pd  # type: ignore
import pytest
import numpy as np
from unittest import mock

from pipeline.preprocessing.ground_truth_processing.GroundTruthHandler import GroundTruthHandler

# Test whether the cleaning of ground truth works.
def test_load_and_clean_ground_truth():
    mock_file_contents = """
    {
    "type": "FeatureCollection",
    "name": "osm_vejman_merged_intersects_no_dupes_no_nulls",
    "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:EPSG::25832" } },
    "features": [{ "type": "Feature", "properties": { "fid": 9, "osm_id": 21457, "osm_name": "Blidahpark", "fid_2": 27756, "BESTYRER": 157.0, "ADMVEJNR": 1570064.0, "ADMVEJDEL": "0", "FRAKMT": 0.0, "FRAKM": 0.0, "FRAM": 0.0, "TILKMT": 479.0, "TILKM": 0.0, "TILM": 479.0, "CPR_VEJNAVN": "BLIDAHPARK", "HAST_VEJSIDE": "Begge", "KODE_HAST_VEJSIDE": "B", "SIDEOFROAD": "B", "ID_HAST_VEJSIDE": 0.0, "SIDEOFROAD_ID": 0.0, "OFFSET": 1.0, "HAST_GENEREL_HAST": "50 - Indenfor byzonetavler", "KODE_HAST_GENEREL_HAST": "50", "HAST_LOKAL_HAST": null, "HAST_GAELDENDE_HAST": 50.0, "HAST_ANBEFALET_HAST": null, "HAST_VAR_HAST_TAVLER": null, "KODE_HAST_VAR_HAST_TAVLER": null, "HAST_BYKODE": "Storkøbenhavn", "KODE_HAST_BYKODE": "1500", "VEJSTIKLASSE": "Lokalvej, sekundær by", "KODE_VEJSTIKLASSE": "9", "VEJTYPESKILTET": "Øvrige veje", "KODE_VEJTYPESKILTET": "9", "HAST_BEMAERKNING": null, "HAST_SENEST_RETTET": "2010-11-12T13:00:06", "HAST_BRUGER": "stla" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 724581.653775824815966, 6183118.270348496735096 ], [ 724582.004382031969726, 6183119.028660978190601 ], [ 724594.444986782968044, 6183142.196674403734505 ], [ 724594.879743648460135, 6183142.902549605816603 ], [ 724648.533445845241658, 6183219.459135936573148 ], [ 724668.759212023578584, 6183251.311456647701561 ], [ 724669.954456275212578, 6183258.257864133454859 ], [ 724668.818367546075024, 6183266.162348870187998 ], [ 724665.300790198380128, 6183273.211398660205305 ], [ 724649.799704507458955, 6183291.002650962211192 ], [ 724640.769062686129473, 6183296.650964732281864 ], [ 724638.354948156396858, 6183298.160364766605198 ], [ 724630.448914877255447, 6183301.464228522032499 ], [ 724623.710768962395377, 6183302.670644924975932 ], [ 724617.171704034903087, 6183302.46516886819154 ], [ 724611.947501988732256, 6183300.792064851149917 ], [ 724607.286837848718278, 6183298.36677152197808 ], [ 724591.132161913090385, 6183277.311806634068489 ], [ 724501.980910204350948, 6183159.462674682959914 ], [ 724500.40265814983286, 6183157.94426042586565 ], [ 724498.432435439201072, 6183156.987869358621538 ], [ 724496.263101198594086, 6183156.687119702808559 ], [ 724494.10700497822836, 6183157.071450929157436 ], [ 724492.175200498546474, 6183158.103242020122707 ], [ 724490.656786241568625, 6183159.681494073942304 ], [ 724489.700395174440928, 6183161.651716785505414 ], [ 724489.399645518045872, 6183163.821051025763154 ], [ 724489.783976744511165, 6183165.977147245779634 ], [ 724490.81576783536002, 6183167.908951725810766 ], [ 724579.981416648835875, 6183285.777115224860609 ], [ 724580.01034033158794, 6183285.815079779364169 ], [ 724597.124635695712641, 6183308.120750867761672 ], [ 724599.446980987442657, 6183310.069211868569255 ], [ 724606.01359601947479, 6183313.486314486712217 ], [ 724607.109894681489095, 6183313.943215728737414 ], [ 724613.83613914961461, 6183316.097364159300923 ], [ 724615.751291260472499, 6183316.42744551319629 ], [ 724624.003386253374629, 6183316.68674985691905 ], [ 724625.456919506308623, 6183316.580633444711566 ], [ 724633.672655416768976, 6183315.109665215946734 ], [ 724635.138020201586187, 6183314.67796141281724 ], [ 724644.280392395099625, 6183310.857442189007998 ], [ 724645.292361017083749, 6183310.334064585156739 ], [ 724648.191567719099112, 6183308.521365707740188 ], [ 724658.105855958769098, 6183302.320365718565881 ], [ 724659.671662545530125, 6183300.983996749855578 ], [ 724676.443146121571772, 6183281.734655012376606 ], [ 724677.428837682586163, 6183280.261821242049336 ], [ 724681.849858676898293, 6183271.402315384708345 ], [ 724682.515201024594717, 6183269.272616194561124 ], [ 724683.969268123270012, 6183259.15575569588691 ], [ 724683.939089610939845, 6183256.972877417691052 ], [ 724682.318705820129253, 6183247.555684171617031 ], [ 724681.329400171875022, 6183244.990375344641507 ], [ 724660.266622619703412, 6183211.819896671921015 ], [ 724660.08967469620984, 6183211.55477078165859 ], [ 724606.582794178975746, 6183135.207679157145321 ], [ 724594.536601098487154, 6183112.774174628779292 ], [ 724584.474622794310562, 6183087.088956874795258 ], [ 724583.36661884363275, 6183085.199833096936345 ], [ 724581.729073114460334, 6183083.745561667717993 ], [ 724579.72227999207098, 6183082.868496809154749 ], [ 724577.542678369558416, 6183082.654491738416255 ], [ 724575.403622839949094, 6183083.124494764022529 ], [ 724573.514499061973765, 6183084.232498714700341 ], [ 724572.060227633453906, 6183085.870044443756342 ], [ 724571.183162774192169, 6183087.876837565563619 ], [ 724570.969157703686506, 6183090.056439188309014 ], [ 724571.439160729176365, 6183092.195494717918336 ], [ 724581.653775824815966, 6183118.270348496735096 ] ] ] ] } }]
    }
    """
    # Mock file for TextIOWrapper in GroundTruthHandler
    with mock.patch("builtins.open", mock.mock_open(read_data=mock_file_contents)) as _:
        file_mock = open("")
        
        actual = GroundTruthHandler.load_from_geojson(file_mock, 3000)

        expected = {
            "osm_id": [21457],
            "KODE_HAST_GENEREL_HAST": [50]
        }
        expected = pd.DataFrame(data=expected)

        assert expected.equals(actual)

# Test whether the cleaning of ground truth removes too recent data
def test_ground_truth_clean_remove_too_new_data():
    mock_file_contents = """
    {
    "type": "FeatureCollection",
    "name": "osm_vejman_merged_intersects_no_dupes_no_nulls",
    "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:EPSG::25832" } },
    "features": [{ "type": "Feature", "properties": { "fid": 9, "osm_id": 21457, "osm_name": "Blidahpark", "fid_2": 27756, "BESTYRER": 157.0, "ADMVEJNR": 1570064.0, "ADMVEJDEL": "0", "FRAKMT": 0.0, "FRAKM": 0.0, "FRAM": 0.0, "TILKMT": 479.0, "TILKM": 0.0, "TILM": 479.0, "CPR_VEJNAVN": "BLIDAHPARK", "HAST_VEJSIDE": "Begge", "KODE_HAST_VEJSIDE": "B", "SIDEOFROAD": "B", "ID_HAST_VEJSIDE": 0.0, "SIDEOFROAD_ID": 0.0, "OFFSET": 1.0, "HAST_GENEREL_HAST": "50 - Indenfor byzonetavler", "KODE_HAST_GENEREL_HAST": "50", "HAST_LOKAL_HAST": null, "HAST_GAELDENDE_HAST": 50.0, "HAST_ANBEFALET_HAST": null, "HAST_VAR_HAST_TAVLER": null, "KODE_HAST_VAR_HAST_TAVLER": null, "HAST_BYKODE": "Storkøbenhavn", "KODE_HAST_BYKODE": "1500", "VEJSTIKLASSE": "Lokalvej, sekundær by", "KODE_VEJSTIKLASSE": "9", "VEJTYPESKILTET": "Øvrige veje", "KODE_VEJTYPESKILTET": "9", "HAST_BEMAERKNING": null, "HAST_SENEST_RETTET": "2019-11-12T13:00:06", "HAST_BRUGER": "stla" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 724581.653775824815966, 6183118.270348496735096 ], [ 724582.004382031969726, 6183119.028660978190601 ], [ 724594.444986782968044, 6183142.196674403734505 ], [ 724594.879743648460135, 6183142.902549605816603 ], [ 724648.533445845241658, 6183219.459135936573148 ], [ 724668.759212023578584, 6183251.311456647701561 ], [ 724669.954456275212578, 6183258.257864133454859 ], [ 724668.818367546075024, 6183266.162348870187998 ], [ 724665.300790198380128, 6183273.211398660205305 ], [ 724649.799704507458955, 6183291.002650962211192 ], [ 724640.769062686129473, 6183296.650964732281864 ], [ 724638.354948156396858, 6183298.160364766605198 ], [ 724630.448914877255447, 6183301.464228522032499 ], [ 724623.710768962395377, 6183302.670644924975932 ], [ 724617.171704034903087, 6183302.46516886819154 ], [ 724611.947501988732256, 6183300.792064851149917 ], [ 724607.286837848718278, 6183298.36677152197808 ], [ 724591.132161913090385, 6183277.311806634068489 ], [ 724501.980910204350948, 6183159.462674682959914 ], [ 724500.40265814983286, 6183157.94426042586565 ], [ 724498.432435439201072, 6183156.987869358621538 ], [ 724496.263101198594086, 6183156.687119702808559 ], [ 724494.10700497822836, 6183157.071450929157436 ], [ 724492.175200498546474, 6183158.103242020122707 ], [ 724490.656786241568625, 6183159.681494073942304 ], [ 724489.700395174440928, 6183161.651716785505414 ], [ 724489.399645518045872, 6183163.821051025763154 ], [ 724489.783976744511165, 6183165.977147245779634 ], [ 724490.81576783536002, 6183167.908951725810766 ], [ 724579.981416648835875, 6183285.777115224860609 ], [ 724580.01034033158794, 6183285.815079779364169 ], [ 724597.124635695712641, 6183308.120750867761672 ], [ 724599.446980987442657, 6183310.069211868569255 ], [ 724606.01359601947479, 6183313.486314486712217 ], [ 724607.109894681489095, 6183313.943215728737414 ], [ 724613.83613914961461, 6183316.097364159300923 ], [ 724615.751291260472499, 6183316.42744551319629 ], [ 724624.003386253374629, 6183316.68674985691905 ], [ 724625.456919506308623, 6183316.580633444711566 ], [ 724633.672655416768976, 6183315.109665215946734 ], [ 724635.138020201586187, 6183314.67796141281724 ], [ 724644.280392395099625, 6183310.857442189007998 ], [ 724645.292361017083749, 6183310.334064585156739 ], [ 724648.191567719099112, 6183308.521365707740188 ], [ 724658.105855958769098, 6183302.320365718565881 ], [ 724659.671662545530125, 6183300.983996749855578 ], [ 724676.443146121571772, 6183281.734655012376606 ], [ 724677.428837682586163, 6183280.261821242049336 ], [ 724681.849858676898293, 6183271.402315384708345 ], [ 724682.515201024594717, 6183269.272616194561124 ], [ 724683.969268123270012, 6183259.15575569588691 ], [ 724683.939089610939845, 6183256.972877417691052 ], [ 724682.318705820129253, 6183247.555684171617031 ], [ 724681.329400171875022, 6183244.990375344641507 ], [ 724660.266622619703412, 6183211.819896671921015 ], [ 724660.08967469620984, 6183211.55477078165859 ], [ 724606.582794178975746, 6183135.207679157145321 ], [ 724594.536601098487154, 6183112.774174628779292 ], [ 724584.474622794310562, 6183087.088956874795258 ], [ 724583.36661884363275, 6183085.199833096936345 ], [ 724581.729073114460334, 6183083.745561667717993 ], [ 724579.72227999207098, 6183082.868496809154749 ], [ 724577.542678369558416, 6183082.654491738416255 ], [ 724575.403622839949094, 6183083.124494764022529 ], [ 724573.514499061973765, 6183084.232498714700341 ], [ 724572.060227633453906, 6183085.870044443756342 ], [ 724571.183162774192169, 6183087.876837565563619 ], [ 724570.969157703686506, 6183090.056439188309014 ], [ 724571.439160729176365, 6183092.195494717918336 ], [ 724581.653775824815966, 6183118.270348496735096 ] ] ] ] } }]
    }
    """
    # Mock file for TextIOWrapper in GroundTruthHandler
    with mock.patch("builtins.open", mock.mock_open(read_data=mock_file_contents)) as _:

        # Use file with 
        file_mock = open("")
        filteredAway = GroundTruthHandler.load_from_geojson(file_mock, 2018)
        file_mock.close()

        file_mock = open("")
        notFiltered = GroundTruthHandler.load_from_geojson(file_mock, 2019)
        file_mock.close()

        assert filteredAway.empty
        assert not notFiltered.empty

# Check whether merging of ground truth at FCD data works
def test_ground_truth_merge():
        expected = {
            "osm_id": [21457],
            "trips": [[[10,5,7],[1,2,3],[6,5,2,1,4,76,8,5,3,22]]],
            "KODE_HAST_GENEREL_HAST": [50]
        }
        expected = pd.DataFrame(data=expected)

        mock_file_contents = """
        {
        "type": "FeatureCollection",
        "name": "osm_vejman_merged_intersects_no_dupes_no_nulls",
        "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:EPSG::25832" } },
        "features": [{ "type": "Feature", "properties": { "fid": 9, "osm_id": 21457, "osm_name": "Blidahpark", "fid_2": 27756, "BESTYRER": 157.0, "ADMVEJNR": 1570064.0, "ADMVEJDEL": "0", "FRAKMT": 0.0, "FRAKM": 0.0, "FRAM": 0.0, "TILKMT": 479.0, "TILKM": 0.0, "TILM": 479.0, "CPR_VEJNAVN": "BLIDAHPARK", "HAST_VEJSIDE": "Begge", "KODE_HAST_VEJSIDE": "B", "SIDEOFROAD": "B", "ID_HAST_VEJSIDE": 0.0, "SIDEOFROAD_ID": 0.0, "OFFSET": 1.0, "HAST_GENEREL_HAST": "50 - Indenfor byzonetavler", "KODE_HAST_GENEREL_HAST": "50", "HAST_LOKAL_HAST": null, "HAST_GAELDENDE_HAST": 50.0, "HAST_ANBEFALET_HAST": null, "HAST_VAR_HAST_TAVLER": null, "KODE_HAST_VAR_HAST_TAVLER": null, "HAST_BYKODE": "Storkøbenhavn", "KODE_HAST_BYKODE": "1500", "VEJSTIKLASSE": "Lokalvej, sekundær by", "KODE_VEJSTIKLASSE": "9", "VEJTYPESKILTET": "Øvrige veje", "KODE_VEJTYPESKILTET": "9", "HAST_BEMAERKNING": null, "HAST_SENEST_RETTET": "2019-11-12T13:00:06", "HAST_BRUGER": "stla" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 724581.653775824815966, 6183118.270348496735096 ], [ 724582.004382031969726, 6183119.028660978190601 ], [ 724594.444986782968044, 6183142.196674403734505 ], [ 724594.879743648460135, 6183142.902549605816603 ], [ 724648.533445845241658, 6183219.459135936573148 ], [ 724668.759212023578584, 6183251.311456647701561 ], [ 724669.954456275212578, 6183258.257864133454859 ], [ 724668.818367546075024, 6183266.162348870187998 ], [ 724665.300790198380128, 6183273.211398660205305 ], [ 724649.799704507458955, 6183291.002650962211192 ], [ 724640.769062686129473, 6183296.650964732281864 ], [ 724638.354948156396858, 6183298.160364766605198 ], [ 724630.448914877255447, 6183301.464228522032499 ], [ 724623.710768962395377, 6183302.670644924975932 ], [ 724617.171704034903087, 6183302.46516886819154 ], [ 724611.947501988732256, 6183300.792064851149917 ], [ 724607.286837848718278, 6183298.36677152197808 ], [ 724591.132161913090385, 6183277.311806634068489 ], [ 724501.980910204350948, 6183159.462674682959914 ], [ 724500.40265814983286, 6183157.94426042586565 ], [ 724498.432435439201072, 6183156.987869358621538 ], [ 724496.263101198594086, 6183156.687119702808559 ], [ 724494.10700497822836, 6183157.071450929157436 ], [ 724492.175200498546474, 6183158.103242020122707 ], [ 724490.656786241568625, 6183159.681494073942304 ], [ 724489.700395174440928, 6183161.651716785505414 ], [ 724489.399645518045872, 6183163.821051025763154 ], [ 724489.783976744511165, 6183165.977147245779634 ], [ 724490.81576783536002, 6183167.908951725810766 ], [ 724579.981416648835875, 6183285.777115224860609 ], [ 724580.01034033158794, 6183285.815079779364169 ], [ 724597.124635695712641, 6183308.120750867761672 ], [ 724599.446980987442657, 6183310.069211868569255 ], [ 724606.01359601947479, 6183313.486314486712217 ], [ 724607.109894681489095, 6183313.943215728737414 ], [ 724613.83613914961461, 6183316.097364159300923 ], [ 724615.751291260472499, 6183316.42744551319629 ], [ 724624.003386253374629, 6183316.68674985691905 ], [ 724625.456919506308623, 6183316.580633444711566 ], [ 724633.672655416768976, 6183315.109665215946734 ], [ 724635.138020201586187, 6183314.67796141281724 ], [ 724644.280392395099625, 6183310.857442189007998 ], [ 724645.292361017083749, 6183310.334064585156739 ], [ 724648.191567719099112, 6183308.521365707740188 ], [ 724658.105855958769098, 6183302.320365718565881 ], [ 724659.671662545530125, 6183300.983996749855578 ], [ 724676.443146121571772, 6183281.734655012376606 ], [ 724677.428837682586163, 6183280.261821242049336 ], [ 724681.849858676898293, 6183271.402315384708345 ], [ 724682.515201024594717, 6183269.272616194561124 ], [ 724683.969268123270012, 6183259.15575569588691 ], [ 724683.939089610939845, 6183256.972877417691052 ], [ 724682.318705820129253, 6183247.555684171617031 ], [ 724681.329400171875022, 6183244.990375344641507 ], [ 724660.266622619703412, 6183211.819896671921015 ], [ 724660.08967469620984, 6183211.55477078165859 ], [ 724606.582794178975746, 6183135.207679157145321 ], [ 724594.536601098487154, 6183112.774174628779292 ], [ 724584.474622794310562, 6183087.088956874795258 ], [ 724583.36661884363275, 6183085.199833096936345 ], [ 724581.729073114460334, 6183083.745561667717993 ], [ 724579.72227999207098, 6183082.868496809154749 ], [ 724577.542678369558416, 6183082.654491738416255 ], [ 724575.403622839949094, 6183083.124494764022529 ], [ 724573.514499061973765, 6183084.232498714700341 ], [ 724572.060227633453906, 6183085.870044443756342 ], [ 724571.183162774192169, 6183087.876837565563619 ], [ 724570.969157703686506, 6183090.056439188309014 ], [ 724571.439160729176365, 6183092.195494717918336 ], [ 724581.653775824815966, 6183118.270348496735096 ] ] ] ] } }]
        }
        """
        # Mock file for TextIOWrapper in GroundTruthHandler
        with mock.patch("builtins.open", mock.mock_open(read_data=mock_file_contents)) as _:
            file_mock = open("")
            data = GroundTruthHandler.load_from_geojson(file_mock, 3000)
            

            fcd_data = pd.DataFrame(data={"osm_id": [21457], "trips": [[[10,5,7],[1,2,3],[6,5,2,1,4,76,8,5,3,22]]]})

            actual = GroundTruthHandler.add_ground_truth_to_FCD_Data(fcd_data, data)
        
            assert expected.equals(actual)